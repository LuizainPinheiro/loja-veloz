name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do C√≥digo
      uses: actions/checkout@v3

    - name: Login no Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build e Push das Imagens
      run: |
        # Limpa espa√ßos ou quebras de linha que possam vir dos secrets
        USER_CLEAN=$(echo "${{ secrets.DOCKERHUB_USERNAME }}" | tr -d '[:space:]')
        
        services=("api-gateway" "pedidos" "estoque" "pagamentos")
        
        for svc in "${services[@]}"; do
          echo "------------------------------------------"
          echo "üî® Construindo: $svc para o usu√°rio: $USER_CLEAN"
          
          IMAGE_TAG="$USER_CLEAN/$svc:latest"
          CONTEXT_PATH="./services/$svc"
          
          if [ -d "$CONTEXT_PATH" ]; then
            # Build com a tag limpa
            docker build -t "$IMAGE_TAG" "$CONTEXT_PATH"
            
            echo "üöÄ Enviando: $IMAGE_TAG"
            docker push "$IMAGE_TAG"
          else
            echo "‚ùå Erro: Pasta $CONTEXT_PATH n√£o encontrada!"
            exit 1
          fi
        done